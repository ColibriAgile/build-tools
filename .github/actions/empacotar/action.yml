name: Empacotar arquivos
description: >-
  Empacota arquivos utilizando o BuildTools. Baixa automaticamente a versão mais recente do BuildTools.exe do repositório ColibriAgile/build-tools e executa o empacotamento de arquivos, recebendo como parâmetros a pasta de origem, a pasta de destino, versão, develop e opções extras. Ideal para automatizar o empacotamento de arquivos em pipelines CI/CD.

inputs:
  pasta-origem:
    description: Caminho da pasta de origem dos arquivos a serem empacotados
    required: true
  pasta-destino:
    description: Caminho da pasta de destino dos arquivos empacotados
    required: true
  versao:
    description: Versão do pacote a ser empacotado
    required: true
  develop:
    description: Indica se é ambiente de desenvolvimento (true/false)
    required: true
  extras:
    description: Parâmetros extras para o BuildTools (opcional)
    required: false

outputs:
  arquivo-gerado:
    description: Caminho completo do arquivo .cmpkg gerado
    value: ${{ steps.arquivo_gerado.outputs.arquivo }}

runs:
  using: composite
  steps:
    - name: Baixar buildTools.exe do GitHub Releases
      uses: robinraju/release-downloader@v1
      with:
        repository: ColibriAgile/build-tools
        latest: true
        fileName: BuildTools.exe
        token: ${{ github.token }}

    - name: Executar buildTools.exe (empacotar)
      shell: pwsh
      run: |
        try {
          .\BuildTools.exe empacotar `
            --pasta "${{ inputs.pasta-origem }}" `
            --saida "${{ inputs.pasta-destino }}" `
            --versao "${{ inputs.versao }}" `
            --develop "${{ inputs.develop }}" `
            --resumo markdown `
            ${{ inputs.extras }}
        } catch {
          Write-Error "Erro ao executar BuildTools.exe: $_"
          exit 1
        }

    - name: Encontrar arquivo gerado
      id: arquivo_gerado
      shell: pwsh
      run: |
        $arquivos = Get-ChildItem -Path "${{ inputs.pasta-destino }}" -Filter *.cmpkg | Sort-Object LastWriteTime -Descending
        if ($arquivos.Count -eq 0) {
          Write-Error "Nenhum arquivo .cmpkg encontrado na pasta de destino."
          exit 1
        }
        $arquivo = $arquivos[0].FullName
        echo "::set-output name=arquivo::$arquivo"
